{% extends "base.html" %}

{% block title %}Work Days - {{ year }}-{{ '%02d'|format(month) }}{% endblock %}

{% block content %}

<div class="d-flex justify-content-between align-items-center mb-3">
    <div>
        {% set prev_month = month - 1 if month > 1 else 12 %}
        {% set prev_year = year if month > 1 else year - 1 %}
        <a href="{{ url_for('work.list', year=prev_year, month=prev_month) }}" class="btn btn-outline-primary me-2">&laquo; {{ prev_year }}-{{ '%02d'|format(prev_month) }}</a>
        <span class="fw-bold fs-4">Work Days for {{ year }}-{{ '%02d'|format(month) }}</span>
        {% set next_month = month + 1 if month < 12 else 1 %}
        {% set next_year = year if month < 12 else year + 1 %}
        <a href="{{ url_for('work.list', year=next_year, month=next_month) }}" class="btn btn-outline-primary ms-2">{{ next_year }}-{{ '%02d'|format(next_month) }} &raquo;</a>
    </div>
    <div>
        <a href="{{ url_for('work.start') }}" class="btn btn-primary">Start Day</a>
        <a href="{{ url_for('work.export') }}" class="btn btn-secondary">Export Excel</a>
    </div>
</div>

<div class="table-responsive-sm">
    <table class="table table-striped">
        <thead>
            <tr>
                <th class="d-none d-md-table-cell">ID</th>
                <th>Date</th>
                <th class="d-none d-lg-table-cell">Trip Details</th>
                <th class="d-none d-lg-table-cell">Odometer Start</th>
                <th class="d-none d-lg-table-cell">Odometer End</th>
                <th class="d-none d-md-table-cell">Total Miles</th>
                <th>Status</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for r in rows %}
            <tr>
                <td class="d-none d-md-table-cell">{{ r.id }}</td>
                <td>{{ r.day }}</td>
                <td>
                    {% set trip_parts = [] %}
                    {% if r.start_location %}
                        {% set _ = trip_parts.append(r.start_location) %}
                    {% endif %}
                    {% if r.segments_str %}
                        {% for seg in r.segments_str.split(' to ') %}
                            {% if seg and seg not in trip_parts %}{% set _ = trip_parts.append(seg) %}{% endif %}
                        {% endfor %}
                    {% endif %}
                    {{ trip_parts | join(' to ') }}
                    {% if r.trip_explanation %}<br><small class="text-muted">{{ r.trip_explanation }}</small>{% endif %}
                </td>
                <td class="d-none d-sm-table-cell">{{ r.start_odo|round(0) if r.start_odo is not none else '' }}</td>
                <td class="d-none d-sm-table-cell">{{ r.end_odo|round(0) if r.end_odo is not none else '' }}</td>
                <td class="d-none d-sm-table-cell">{{ r.total_miles|round(0) if r.total_miles is not none else '' }}</td>
                <td>
                    {% if r.status == 'started' %}
                        <span class="badge bg-warning text-dark">Started</span>
                    {% else %}
                        <span class="badge bg-success">Ended</span>
                    {% endif %}
                </td>
                <td>
                    <div class="action-buttons">
                        {% if r.status == 'started' %}
                        <a href="{{ url_for('work.end', day_id=r.id) }}" class="btn btn-outline-success btn-sm">End</a>
                        {% endif %}
                        <a href="{{ url_for('work.view', day_id=r.id) }}" class="btn btn-outline-primary btn-sm">View</a>
                        <a href="{{ url_for('work.update', day_id=r.id) }}" class="btn btn-outline-secondary btn-sm">Edit</a>
                        <form method="POST" action="{{ url_for('work.delete', day_id=r.id) }}" class="d-inline" onsubmit="return confirm('Are you sure you want to delete this work day? This cannot be undone.');">
                            <button type="submit" class="btn btn-outline-danger btn-sm">Delete</button>
                        </form>
                    </div>
                </td>
            </tr>
            {% endfor %}
            {% if not rows %}
            <tr>
                <td colspan="9" class="text-center">No work days found for this month.</td>
            </tr>
            {% endif %}
        </tbody>
    </table>
</div>
{% endblock %}